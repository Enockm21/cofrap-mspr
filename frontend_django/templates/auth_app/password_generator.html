{% extends 'base.html' %}
{% load static %}

{% block title %}G√©n√©ration Mot de Passe - Cofrap{% endblock %}

{% block content %}
<div class="hero">
    <div class="container">
        <h1>
            <i class="fas fa-magic"></i>
            G√©n√©ration de Mot de Passe S√©curis√©
        </h1>
        <p>{{ next_step }} - Votre mot de passe unique et s√©curis√©</p>
    </div>
</div>

<div class="container">
    <!-- Indicateur de progression -->
    {% if is_registration %}
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-lg-8">
            <div class="workflow-steps">
                <div class="step completed">
                    <div class="step-number"><i class="fas fa-check"></i></div>
                    <div class="step-label">Cr√©ation utilisateur</div>
                </div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <div class="step-label">G√©n√©ration mot de passe</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-label">Configuration 2FA</div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-label">Authentification</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="text-center">
                        <i class="fas fa-key"></i>
                        {% if is_registration %}
                            √âtape {{ step }}: G√©n√©ration de votre mot de passe
                        {% else %}
                            G√©n√©rateur de Mots de Passe
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    {% if is_registration %}
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        <strong>Utilisateur :</strong> {{ user.username }}<br>
                        <strong>Email :</strong> {{ user.email|default:"Sera g√©n√©r√© automatiquement" }}<br>
                        Nous allons maintenant cr√©er un mot de passe s√©curis√© de 24 caract√®res avec un QR code pour faciliter la saisie.
                    </div>
                    {% endif %}

                    <!-- Bouton de g√©n√©ration principal -->
                    <div class="text-center mb-4">
                        <button type="button" 
                                class="btn btn-primary btn-lg" 
                                id="generate-password-btn">
                            <i class="fas fa-magic"></i>
                            G√©n√©rer le Mot de Passe S√©curis√©
                        </button>
                    </div>

                    <!-- Zone de r√©sultat -->
                    <div class="password-result mt-4" id="password-result" style="display: none;">
                        <div class="text-center mb-3">
                            <h5><i class="fas fa-check-circle text-success"></i> Mot de passe g√©n√©r√© avec succ√®s !</h5>
                        </div>

                        <!-- Mot de passe g√©n√©r√© -->
                        <div class="password-display mb-4">
                            <h6>Votre mot de passe s√©curis√© :</h6>
                            <div class="password-container">
                                <div class="password-field">
                                    <input type="text" 
                                           id="generated-password" 
                                           class="form-control" 
                                           readonly 
                                           style="font-family: monospace; font-size: 1.1rem; background: #f8f9fa; border: 2px solid #dee2e6;">
                                </div>
                                <button type="button" 
                                        class="btn btn-outline-primary btn-sm ms-2" 
                                        id="copy-password-btn"
                                        title="Copier le mot de passe">
                                    <i class="fas fa-copy"></i> Copier
                                </button>
                            </div>
                            <small class="text-muted">Cliquez sur "Copier" pour sauvegarder ce mot de passe</small>
                        </div>

                        <!-- QR Code -->
                        <div class="qr-code-container text-center mb-4">
                            <h6>QR Code du mot de passe :</h6>
                            <div class="qr-code-display">
                                <img id="qr-code-img" src="" alt="QR Code du mot de passe" style="max-width: 200px;">
                            </div>
                            <small class="text-muted">Scannez ce QR code pour saisir automatiquement votre mot de passe</small>
                        </div>

                        <!-- Informations de g√©n√©ration -->
                        <div class="generation-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <span class="info-label">Utilisateur :</span>
                                        <span class="info-value">{{ user.username }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <span class="info-label">Date de g√©n√©ration :</span>
                                        <span class="info-value" id="generation-date">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions suivantes -->
                        {% if is_registration %}
                        <div class="next-actions mt-4">
                            <div class="alert alert-success">
                                <i class="fas fa-info-circle"></i>
                                <strong>√âtape suivante :</strong> Configuration de l'authentification √† deux facteurs (2FA)
                            </div>
                            <div class="d-grid">
                                <button type="button" 
                                        class="btn btn-success btn-lg" 
                                        id="continue-to-2fa">
                                    <i class="fas fa-arrow-right"></i>
                                    Continuer vers la configuration 2FA
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="d-grid gap-2 mt-4">
                            <button type="button" 
                                    class="btn btn-secondary" 
                                    id="regenerate-password">
                                <i class="fas fa-sync-alt"></i>
                                G√©n√©rer un nouveau mot de passe
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Zone d'erreur -->
                    <div class="error-result mt-4" id="error-result" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="error-message">Une erreur est survenue</span>
                        </div>
                        <div class="d-grid">
                            <button type="button" 
                                    class="btn btn-primary" 
                                    id="retry-generation">
                                <i class="fas fa-redo"></i>
                                R√©essayer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conseils de s√©curit√© -->
            <div class="card fade-in mt-4">
                <div class="card-header">
                    <h4>
                        <i class="fas fa-shield-alt"></i>
                        S√©curit√© du Mot de Passe
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>‚úÖ Caract√©ristiques du mot de passe :</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> 24 caract√®res de longueur</li>
                                <li><i class="fas fa-check text-success"></i> Combinaison de majuscules, minuscules, chiffres et symboles</li>
                                <li><i class="fas fa-check text-success"></i> G√©n√©r√© de fa√ßon cryptographiquement s√©curis√©e</li>
                                <li><i class="fas fa-check text-success"></i> Stock√© de fa√ßon chiffr√©e en base</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>üîí Recommandations :</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-info text-primary"></i> Utilisez le QR code pour saisir facilement</li>
                                <li><i class="fas fa-info text-primary"></i> Le mot de passe expire automatiquement apr√®s 6 mois</li>
                                <li><i class="fas fa-info text-primary"></i> L'historique des mots de passe est conserv√©</li>
                                <li><i class="fas fa-info text-primary"></i> La 2FA ajoute une couche de s√©curit√© suppl√©mentaire</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.workflow-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    position: relative;
}

.workflow-steps::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gray-300);
    z-index: 1;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    padding: 0.5rem;
    z-index: 2;
    position: relative;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--gray-300);
    color: var(--gray-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background: var(--primary-color);
    color: white;
}

.step.completed .step-number {
    background: var(--success-color, #28a745);
    color: white;
}

.step-label {
    font-size: 0.875rem;
    text-align: center;
    color: var(--gray-600);
    max-width: 80px;
}

.step.active .step-label {
    color: var(--primary-color);
    font-weight: 600;
}

.step.completed .step-label {
    color: var(--success-color, #28a745);
    font-weight: 600;
}

.password-result, .error-result {
    background: var(--gray-50);
    padding: 1.5rem;
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--gray-200);
}

.qr-code-display {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    display: inline-block;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.generation-info {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    border: 1px solid var(--gray-200);
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
}

.info-label {
    color: var(--gray-600);
    font-size: 0.875rem;
}

.info-value {
    font-weight: 600;
    color: var(--primary-color);
}

.next-actions {
    border-top: 1px solid var(--gray-200);
    padding-top: 1rem;
}

.password-display {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    border: 1px solid var(--gray-200);
}

.password-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.password-field {
    flex: 1;
}

#copy-password-btn {
    min-width: 80px;
    white-space: nowrap;
}

#copy-password-btn:hover {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

#copy-password-btn.copied {
    background-color: var(--success-color, #28a745);
    border-color: var(--success-color, #28a745);
    color: white;
}

@media (max-width: 768px) {
    .step-label {
        font-size: 0.75rem;
        max-width: 60px;
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
    }
    
    .qr-code-display img {
        max-width: 150px !important;
    }
    
    .password-container {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .password-field {
        width: 100%;
    }
    
    #copy-password-btn {
        width: 100%;
    }
    
    #generated-password {
        font-size: 0.9rem !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-password-btn');
    const continueBtn = document.getElementById('continue-to-2fa');
    const retryBtn = document.getElementById('retry-generation');
    const regenerateBtn = document.getElementById('regenerate-password');
    const passwordResult = document.getElementById('password-result');
    const errorResult = document.getElementById('error-result');
    const qrCodeImg = document.getElementById('qr-code-img');
    const errorMessage = document.getElementById('error-message');
    const generationDate = document.getElementById('generation-date');
    const generatedPasswordField = document.getElementById('generated-password');
    const copyPasswordBtn = document.getElementById('copy-password-btn');

    async function generatePassword() {
        try {
            // D√©sactiver le bouton
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration en cours...';
            generateBtn.disabled = true;
            
            // Masquer les r√©sultats pr√©c√©dents
            passwordResult.style.display = 'none';
            errorResult.style.display = 'none';

            const response = await fetch('{% url "auth_app:generate_password" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    username: '{{ user.username }}'
                })
            });

            const data = await response.json();

            if (data.success) {
                // Afficher le mot de passe g√©n√©r√©
                if (data.password) {
                    generatedPasswordField.value = data.password;
                }
                
                // Afficher le QR code
                qrCodeImg.src = 'data:image/png;base64,' + data.qr_code;
                
                // Afficher la date de g√©n√©ration
                if (data.gendate) {
                    const date = new Date(data.gendate * 1000);
                    generationDate.textContent = date.toLocaleString('fr-FR');
                }
                
                passwordResult.style.display = 'block';
                showNotification(data.message || 'Mot de passe g√©n√©r√© avec succ√®s !', 'success');
            } else {
                errorMessage.textContent = data.error || 'Erreur lors de la g√©n√©ration';
                errorResult.style.display = 'block';
                showNotification('Erreur lors de la g√©n√©ration du mot de passe', 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            errorMessage.textContent = 'Erreur de connexion au serveur';
            errorResult.style.display = 'block';
            showNotification('Erreur de connexion', 'error');
        } finally {
            // Restaurer le bouton
            generateBtn.innerHTML = '<i class="fas fa-magic"></i> G√©n√©rer le Mot de Passe S√©curis√©';
            generateBtn.disabled = false;
        }
    }

    // √âv√©nements
    generateBtn.addEventListener('click', generatePassword);
    
    if (retryBtn) {
        retryBtn.addEventListener('click', generatePassword);
    }
    
    if (regenerateBtn) {
        regenerateBtn.addEventListener('click', generatePassword);
    }
    
    if (continueBtn) {
        continueBtn.addEventListener('click', function() {
            window.location.href = '{% url "auth_app:two_factor" %}';
        });
    }
    
    // Fonctionnalit√© de copie du mot de passe
    if (copyPasswordBtn) {
        copyPasswordBtn.addEventListener('click', async function() {
            try {
                const password = generatedPasswordField.value;
                if (!password) {
                    showNotification('Aucun mot de passe √† copier', 'warning');
                    return;
                }
                
                // Copier dans le presse-papiers
                await navigator.clipboard.writeText(password);
                
                // Feedback visuel
                const originalContent = copyPasswordBtn.innerHTML;
                copyPasswordBtn.innerHTML = '<i class="fas fa-check"></i> Copi√© !';
                copyPasswordBtn.classList.add('copied');
                
                showNotification('Mot de passe copi√© dans le presse-papiers !', 'success');
                
                // Restaurer le bouton apr√®s 2 secondes
                setTimeout(() => {
                    copyPasswordBtn.innerHTML = originalContent;
                    copyPasswordBtn.classList.remove('copied');
                }, 2000);
                
            } catch (err) {
                console.error('Erreur lors de la copie:', err);
                showNotification('Erreur lors de la copie. Veuillez s√©lectionner le texte manuellement.', 'error');
                
                // Fallback: s√©lectionner le texte
                generatedPasswordField.select();
                generatedPasswordField.setSelectionRange(0, 99999); // Pour mobile
            }
        });
    }

    // Fonction de notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} notification`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }
});
</script>
{% endblock %} 