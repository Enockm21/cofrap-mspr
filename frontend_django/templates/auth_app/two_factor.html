{% extends 'base.html' %}
{% load static %}

{% block title %}Authentification √† Deux Facteurs - Cofrap{% endblock %}

{% block content %}
<div class="hero">
    <div class="container">
        <h1>
            <i class="fas fa-shield-alt"></i>
            Authentification √† Deux Facteurs
        </h1>
        <p>S√©curisez votre compte avec une authentification renforc√©e</p>
    </div>
</div>

<div class="container">
    <!-- Token CSRF pour les requ√™tes AJAX -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    
    <!-- Indicateur de progression pour le workflow d'inscription -->
    {% if is_registration %}
    <div class="row justify-content-center mb-4">
        <div class="col-12 col-lg-8">
            <div class="workflow-steps">
                <div class="step completed">
                    <div class="step-number"><i class="fas fa-check"></i></div>
                    <div class="step-label">Cr√©ation utilisateur</div>
                </div>
                <div class="step completed">
                    <div class="step-number"><i class="fas fa-check"></i></div>
                    <div class="step-label">G√©n√©ration mot de passe</div>
                </div>
                <div class="step active">
                    <div class="step-number">3</div>
                    <div class="step-label">Configuration 2FA</div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-label">Authentification</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <!-- √âtat actuel de la 2FA -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="text-center">
                        <i class="fas fa-mobile-alt"></i>
                        {% if is_registration %}
                            √âtape {{ step }}: Configuration 2FA
                        {% else %}
                            √âtat de votre 2FA
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5>Authentification √† deux facteurs</h5>
                            <p class="text-muted">
                                {% if is_registration %}
                                    üîß Configuration de la 2FA pour le compte <strong>{{ user.username }}</strong><br>
                                    Cette √©tape renforcera la s√©curit√© de votre nouveau compte.
                                {% elif user_2fa_enabled %}
                                    ‚úÖ Votre compte est prot√©g√© par l'authentification √† deux facteurs
                                {% else %}
                                    ‚ö†Ô∏è Votre compte n'est pas encore prot√©g√© par l'authentification √† deux facteurs
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-center">
                            {% if is_registration %}
                                <span class="badge bg-primary fs-6">
                                    <i class="fas fa-cog fa-spin"></i> Configuration en cours
                                </span>
                            {% elif user_2fa_enabled %}
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check"></i> Activ√©e
                                </span>
                            {% else %}
                                <span class="badge bg-warning fs-6">
                                    <i class="fas fa-exclamation-triangle"></i> Non activ√©e
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% if not user_2fa_enabled %}
            <!-- Configuration de la 2FA -->
            <div class="card fade-in mt-4">
                <div class="card-header">
                    <h4 class="text-center">
                        <i class="fas fa-cog"></i>
                        Configuration de la 2FA
                    </h4>
                </div>
                <div class="card-body">
                    <div class="setup-steps">
                        <!-- √âtape 1: G√©n√©ration du QR Code -->
                        <div class="step" id="step-1">
                            <div class="step-header">
                                <span class="step-number">1</span>
                                <h5>G√©n√©rer le QR Code</h5>
                            </div>
                            <div class="step-content">
                                <p>Cliquez sur le bouton ci-dessous pour g√©n√©rer un nouveau QR Code pour votre application d'authentification.</p>
                                <button type="button" class="btn btn-primary" id="generate-qr-btn">
                                    <i class="fas fa-qrcode"></i>
                                    G√©n√©rer le QR Code
                                </button>
                            </div>
                        </div>

                        <!-- √âtape 2: Scanner le QR Code -->
                        <div class="step" id="step-2" style="display: none;">
                            <div class="step-header">
                                <span class="step-number">2</span>
                                <h5>Scanner le QR Code</h5>
                            </div>
                            <div class="step-content">
                                <div class="qr-section">
                                    <div class="qr-container">
                                        <div id="qr-code-placeholder" class="qr-placeholder">
                                            <i class="fas fa-qrcode fa-3x text-muted"></i>
                                            <p class="mt-2">QR Code en cours de g√©n√©ration...</p>
                                        </div>
                                        <div id="qr-code-display" style="display: none;">
                                            <img id="qr-code-image" alt="QR Code 2FA" class="qr-image">
                                            <div class="qr-info">
                                                <p><strong>Cl√© secr√®te:</strong> <span id="secret-key"></span></p>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="copy-secret">
                                                    <i class="fas fa-copy"></i> Copier
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="qr-instructions">
                                        <h6>Instructions :</h6>
                                        <ol>
                                            <li>T√©l√©chargez une application d'authentification si vous n'en avez pas :
                                                <ul>
                                                    <li><strong>Google Authenticator</strong> (Android/iOS)</li>
                                                    <li><strong>Authy</strong> (Android/iOS/Desktop)</li>
                                                    <li><strong>Microsoft Authenticator</strong> (Android/iOS)</li>
                                                </ul>
                                            </li>
                                            <li>Ouvrez votre application d'authentification</li>
                                            <li>Scannez le QR Code ci-dessus ou entrez manuellement la cl√© secr√®te</li>
                                            <li>Notez les codes de r√©cup√©ration qui s'affichent</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- √âtape 3: V√©rification -->
                        <div class="step" id="step-3" style="display: none;">
                            <div class="step-header">
                                <span class="step-number">3</span>
                                <h5>V√©rifier la configuration</h5>
                            </div>
                            <div class="step-content">
                                <p>Entrez le code √† 6 chiffres affich√© dans votre application d'authentification pour v√©rifier que tout fonctionne correctement.</p>
                                
                                <div class="form-group">
                                    <label for="verification-code" class="form-label">
                                        <i class="fas fa-mobile-alt"></i> Code de v√©rification
                                    </label>
                                    <input type="text" 
                                           class="form-control form-control-lg text-center" 
                                           id="verification-code" 
                                           placeholder="000000"
                                           maxlength="6"
                                           pattern="[0-9]{6}">
                                    <small class="form-text text-muted">
                                        Entrez le code √† 6 chiffres de votre application
                                    </small>
                                </div>

                                <div class="d-grid gap-2 mt-3">
                                    <button type="button" class="btn btn-success btn-lg" id="verify-code-btn">
                                        <i class="fas fa-check"></i>
                                        V√©rifier et Activer la 2FA
                                    </button>
                                </div>

                                <!-- Section codes de r√©cup√©ration apr√®s v√©rification -->
                                <div class="recovery-section mt-4" id="recovery-section" style="display: none;">
                                    <div class="alert alert-success">
                                        <h6><i class="fas fa-key"></i> Codes de r√©cup√©ration g√©n√©r√©s</h6>
                                        <p class="mb-2">Voici vos codes de r√©cup√©ration. Conservez-les pr√©cieusement !</p>
                                        
                                        <div class="recovery-codes-display" id="recovery-codes-display">
                                            <!-- Les codes seront affich√©s ici -->
                                        </div>
                                        
                                        <div class="text-center mt-3">
                                            <button type="button" class="btn btn-primary me-2" id="print-codes-direct">
                                                <i class="fas fa-print"></i> Imprimer
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="download-codes-direct">
                                                <i class="fas fa-download"></i> T√©l√©charger
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Gestion de la 2FA activ√©e -->
            <div class="card fade-in mt-4">
                <div class="card-header">
                    <h4 class="text-center">
                        <i class="fas fa-tools"></i>
                        Gestion de votre 2FA
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Codes de r√©cup√©ration</h6>
                            <p class="text-muted">Vous avez <strong>{{ recovery_codes_count|default:10 }}</strong> codes de r√©cup√©ration restants.</p>
                            <button type="button" class="btn btn-outline-primary" id="show-recovery-codes">
                                <i class="fas fa-key"></i>
                                Afficher les codes
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>D√©sactiver la 2FA</h6>
                            <p class="text-muted">Attention : cela r√©duira la s√©curit√© de votre compte.</p>
                            <button type="button" class="btn btn-outline-danger" id="disable-2fa-btn">
                                <i class="fas fa-times"></i>
                                D√©sactiver la 2FA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Informations sur la 2FA -->
            <div class="card fade-in mt-4">
                <div class="card-header">
                    <h4>
                        <i class="fas fa-info-circle"></i>
                        √Ä propos de l'authentification √† deux facteurs
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üîí Comment √ßa marche ?</h6>
                            <p>L'authentification √† deux facteurs ajoute une couche de s√©curit√© suppl√©mentaire √† votre compte. En plus de votre mot de passe, vous devrez entrer un code temporaire g√©n√©r√© par votre application d'authentification.</p>
                        </div>
                        <div class="col-md-6">
                            <h6>üì± Applications recommand√©es</h6>
                            <ul class="list-unstyled">
                                <li><i class="fab fa-google"></i> Google Authenticator</li>
                                <li><i class="fas fa-mobile-alt"></i> Authy</li>
                                <li><i class="fab fa-microsoft"></i> Microsoft Authenticator</li>
                                <li><i class="fas fa-lock"></i> 1Password</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-lightbulb"></i> Conseils de s√©curit√©</h6>
                        <ul class="mb-0">
                            <li>Gardez vos codes de r√©cup√©ration dans un endroit s√ªr</li>
                            <li>N'utilisez pas la m√™me application pour plusieurs comptes sensibles</li>
                            <li>V√©rifiez r√©guli√®rement que votre application fonctionne</li>
                            <li>En cas de perte d'acc√®s, utilisez vos codes de r√©cup√©ration</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les codes de r√©cup√©ration -->
{% comment %} <div class="modal fade" id="recoveryCodesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key"></i>
                    Codes de r√©cup√©ration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Important :</strong> Conservez ces codes dans un endroit s√ªr. Ils vous permettront de r√©cup√©rer l'acc√®s √† votre compte si vous perdez votre appareil d'authentification.
                </div>
                
                <div class="recovery-codes-container">
                    <div class="row" id="recovery-codes-list">
                        <!-- Les codes seront g√©n√©r√©s ici -->
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-primary" id="print-codes">
                        <i class="fas fa-print"></i>
                        Imprimer
                    </button>
                    <button type="button" class="btn btn-secondary" id="download-codes">
                        <i class="fas fa-download"></i>
                        T√©l√©charger
                    </button>
                </div>
            </div>
        </div>
    </div>
</div> {% endcomment %}
{% endblock %}

{% block extra_js %}
<script>
// Fonction pour r√©cup√©rer le token CSRF
function getCSRFToken() {
    // M√©thode 1: depuis l'input cach√©
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput && csrfInput.value) {
        return csrfInput.value;
    }
    
    // M√©thode 2: depuis les cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const cookieToken = getCookie('csrftoken');
    if (cookieToken) {
        return cookieToken;
    }
    
    // M√©thode 3: depuis le meta tag (si d√©fini)
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    throw new Error('Token CSRF non trouv√© par aucune m√©thode');
}

document.addEventListener('DOMContentLoaded', function() {
    const generateQrBtn = document.getElementById('generate-qr-btn');
    const verifyCodeBtn = document.getElementById('verify-code-btn');
    const verificationCode = document.getElementById('verification-code');
    const showRecoveryCodesBtn = document.getElementById('show-recovery-codes');
    const disable2faBtn = document.getElementById('disable-2fa-btn');

    {% if not user_2fa_enabled %}
    // G√©n√©ration du QR Code
    if (generateQrBtn) {
        generateQrBtn.addEventListener('click', async function() {
            this.innerHTML = '<span class="spinner"></span> G√©n√©ration...';
            this.disabled = true;

            try {
                const csrfToken = getCSRFToken();

                const response = await fetch('{% url "auth_app:generate_2fa" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Afficher le QR Code
                    document.getElementById('qr-code-placeholder').style.display = 'none';
                    document.getElementById('qr-code-display').style.display = 'block';
                    document.getElementById('qr-code-image').src = 'data:image/png;base64,' + data.qr_code;
                    document.getElementById('secret-key').textContent = data.provisioning_uri || 'Cl√© g√©n√©r√©e avec succ√®s';
                    
                    // Passer √† l'√©tape suivante
                    document.getElementById('step-1').style.display = 'none';
                    document.getElementById('step-2').style.display = 'block';
                    document.getElementById('step-3').style.display = 'block';
                    
                    showNotification('QR Code g√©n√©r√© avec succ√®s !', 'success');
                } else {
                    throw new Error('Erreur lors de la g√©n√©ration');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de la g√©n√©ration du QR Code', 'error');
            } finally {
                this.innerHTML = '<i class="fas fa-qrcode"></i> G√©n√©rer le QR Code';
                this.disabled = false;
            }
        });
    }

    // Copier la cl√© secr√®te
    const copySecretBtn = document.getElementById('copy-secret');
    if (copySecretBtn) {
        copySecretBtn.addEventListener('click', function() {
            const secretKey = document.getElementById('secret-key').textContent;
            navigator.clipboard.writeText(secretKey).then(() => {
                showNotification('Cl√© secr√®te copi√©e !', 'success');
            });
        });
    }

    // V√©rification du code
    if (verifyCodeBtn) {
        verifyCodeBtn.addEventListener('click', async function() {
            const code = verificationCode.value.trim();
            
            if (code.length !== 6 || !/^\d{6}$/.test(code)) {
                showNotification('Veuillez entrer un code √† 6 chiffres valide', 'error');
                return;
            }

            this.innerHTML = '<span class="spinner"></span> V√©rification...';
            this.disabled = true;

            try {
                const csrfToken = getCSRFToken();

                const response = await fetch('{% url "auth_app:verify_2fa" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        code: code
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification(data.message || '2FA activ√©e avec succ√®s !', 'success');
                        
                        // G√©n√©rer et afficher les codes de r√©cup√©ration
                        generateAndShowRecoveryCodes();
                        
                        // Rediriger vers la page appropri√©e apr√®s un d√©lai plus long
                        setTimeout(() => {
                            if (data.next_url) {
                                window.location.href = data.next_url;
                            } else {
                                window.location.reload();
                            }
                        }, 5000); // Plus de temps pour voir les codes
                    } else {
                        showNotification(data.error || 'Code incorrect. Veuillez r√©essayer.', 'error');
                    }
                } else {
                    throw new Error('Erreur lors de la v√©rification');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de la v√©rification', 'error');
            } finally {
                this.innerHTML = '<i class="fas fa-check"></i> V√©rifier et Activer la 2FA';
                this.disabled = false;
            }
        });
    }

    // Auto-soumission quand le code est complet
    if (verificationCode) {
        verificationCode.addEventListener('input', function() {
            if (this.value.length === 6) {
                verifyCodeBtn.click();
            }
        });
    }
    {% endif %}

    {% if user_2fa_enabled %}
    // Afficher les codes de r√©cup√©ration
    if (showRecoveryCodesBtn) {
        showRecoveryCodesBtn.addEventListener('click', async function() {
            try {
                const csrfToken = getCSRFToken();
                const headers = {
                    'X-CSRFToken': csrfToken
                };

                const response = await fetch('{% url "auth_app:get_recovery_codes" %}', {
                    method: 'GET',
                    headers: headers
                });

                if (response.ok) {
                    const data = await response.json();
                    displayRecoveryCodes(data.recovery_codes);
                    
                    // V√©rifier si la modale existe (elle peut √™tre comment√©e)
                    const modal = document.getElementById('recoveryCodesModal');
                    if (modal) {
                        new bootstrap.Modal(modal).show();
                    } else {
                        // Afficher les codes directement si la modale n'existe pas
                        const codesText = data.recovery_codes.map((code, index) => `${index + 1}. ${code}`).join('\n');
                        alert(`Codes de r√©cup√©ration :\n\n${codesText}\n\nVeuillez les noter dans un endroit s√ªr.`);
                    }
                } else {
                    throw new Error('Erreur lors de la r√©cup√©ration');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de la r√©cup√©ration des codes', 'error');
            }
        });
    }

    // D√©sactiver la 2FA
    if (disable2faBtn) {
        disable2faBtn.addEventListener('click', function() {
            if (confirm('√ätes-vous s√ªr de vouloir d√©sactiver l\'authentification √† deux facteurs ? Cela r√©duira la s√©curit√© de votre compte.')) {
                disable2FA();
            }
        });
    }
    {% endif %}

    // Fonction pour afficher les codes de r√©cup√©ration
    function displayRecoveryCodes(codes) {
        const container = document.getElementById('recovery-codes-list');
        if (!container) {
            // Le conteneur n'existe pas (modale comment√©e)
            console.log('Conteneur recovery-codes-list non trouv√©');
            return;
        }
        
        container.innerHTML = '';
        
        codes.forEach((code, index) => {
            const col = document.createElement('div');
            col.className = 'col-6 col-md-4 mb-2';
            col.innerHTML = `
                <div class="recovery-code-item">
                    <span class="code-number">${index + 1}</span>
                    <span class="code-value">${code}</span>
                </div>
            `;
            container.appendChild(col);
        });
    }

    // Fonction pour d√©sactiver la 2FA
    async function disable2FA() {
        try {
            const csrfToken = getCSRFToken();

            const response = await fetch('{% url "auth_app:disable_2fa" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            if (response.ok) {
                showNotification('2FA d√©sactiv√©e avec succ√®s', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                throw new Error('Erreur lors de la d√©sactivation');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showNotification('Erreur lors de la d√©sactivation', 'error');
        }
    }

    // Gestion des boutons Imprimer et T√©l√©charger des codes de r√©cup√©ration
    // Note: Ces boutons sont dans la modale qui peut √™tre comment√©e
    const printCodesBtn = document.getElementById('print-codes');
    const downloadCodesBtn = document.getElementById('download-codes');
    const printCodesDirectBtn = document.getElementById('print-codes-direct');
    const downloadCodesDirectBtn = document.getElementById('download-codes-direct');

    if (printCodesBtn) {
        printCodesBtn.addEventListener('click', function() {
            printRecoveryCodes();
        });
    }

    if (downloadCodesBtn) {
        downloadCodesBtn.addEventListener('click', function() {
            downloadRecoveryCodes();
        });
    }

    if (printCodesDirectBtn) {
        printCodesDirectBtn.addEventListener('click', function() {
            printRecoveryCodesFromDirect();
        });
    }

    if (downloadCodesDirectBtn) {
        downloadCodesDirectBtn.addEventListener('click', function() {
            downloadRecoveryCodesFromDirect();
        });
    }

    // Fonction pour imprimer les codes de r√©cup√©ration
    function printRecoveryCodes() {
        const codes = Array.from(document.querySelectorAll('.code-value')).map(el => el.textContent);
        
        if (codes.length === 0) {
            showNotification('Aucun code de r√©cup√©ration √† imprimer. Veuillez d\'abord afficher les codes.', 'warning');
            return;
        }

        // Cr√©er une nouvelle fen√™tre pour l'impression
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleDateString('fr-FR');
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Codes de R√©cup√©ration 2FA - Cofrap</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        padding: 20px; 
                        line-height: 1.6;
                    }
                    .header { 
                        text-align: center; 
                        margin-bottom: 30px; 
                        border-bottom: 2px solid #333; 
                        padding-bottom: 20px;
                    }
                    .codes-grid { 
                        display: grid; 
                        grid-template-columns: repeat(2, 1fr); 
                        gap: 15px; 
                        margin: 20px 0;
                    }
                    .code-item { 
                        border: 1px solid #ddd; 
                        padding: 15px; 
                        border-radius: 5px; 
                        font-family: 'Courier New', monospace; 
                        font-weight: bold;
                        font-size: 14px;
                    }
                    .warning { 
                        background-color: #fff3cd; 
                        border: 1px solid #ffeaa7; 
                        color: #856404; 
                        padding: 15px; 
                        border-radius: 5px; 
                        margin: 20px 0;
                    }
                    .instructions {
                        margin-top: 30px;
                        font-size: 12px;
                        color: #666;
                    }
                    @media print {
                        body { font-size: 12px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Codes de R√©cup√©ration 2FA</h1>
                    <h2>Cofrap Security</h2>
                    <p>G√©n√©r√©s le : ${currentDate}</p>
                </div>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è IMPORTANT :</strong> Conservez ces codes dans un endroit s√ªr et s√©curis√©. 
                    Ils vous permettront de r√©cup√©rer l'acc√®s √† votre compte si vous perdez votre appareil d'authentification.
                </div>
                
                <div class="codes-grid">
                    ${codes.map((code, index) => `
                        <div class="code-item">
                            ${index + 1}. ${code}
                        </div>
                    `).join('')}
                </div>
                
                <div class="instructions">
                    <h3>Instructions d'utilisation :</h3>
                    <ul>
                        <li>Chaque code ne peut √™tre utilis√© qu'une seule fois</li>
                        <li>Utilisez ces codes uniquement si vous perdez l'acc√®s √† votre appareil 2FA</li>
                        <li>Conservez ce document dans un coffre-fort ou un endroit s√©curis√©</li>
                        <li>Si vous utilisez tous vos codes, g√©n√©rez-en de nouveaux depuis votre compte</li>
                    </ul>
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.focus();
        
        // Imprimer apr√®s un court d√©lai pour s'assurer que le contenu est charg√©
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
        
        showNotification('Impression des codes de r√©cup√©ration...', 'info');
    }

    // Fonction pour t√©l√©charger les codes de r√©cup√©ration
    function downloadRecoveryCodes() {
        const codes = Array.from(document.querySelectorAll('.code-value')).map(el => el.textContent);
        
        if (codes.length === 0) {
            showNotification('Aucun code de r√©cup√©ration √† t√©l√©charger. Veuillez d\'abord afficher les codes.', 'warning');
            return;
        }

        const currentDate = new Date().toLocaleDateString('fr-FR');
        const currentTime = new Date().toLocaleTimeString('fr-FR');
        
        // Cr√©er le contenu du fichier
        const content = `CODES DE R√âCUP√âRATION 2FA - COFRAP
G√©n√©r√©s le : ${currentDate} √† ${currentTime}

‚ö†Ô∏è IMPORTANT : Conservez ces codes dans un endroit s√ªr et s√©curis√©.
Ils vous permettront de r√©cup√©rer l'acc√®s √† votre compte si vous perdez votre appareil d'authentification.

CODES DE R√âCUP√âRATION :
${codes.map((code, index) => `${(index + 1).toString().padStart(2, '0')}. ${code}`).join('\n')}

INSTRUCTIONS D'UTILISATION :
- Chaque code ne peut √™tre utilis√© qu'une seule fois
- Utilisez ces codes uniquement si vous perdez l'acc√®s √† votre appareil 2FA
- Conservez ce fichier dans un endroit s√©curis√©
- Si vous utilisez tous vos codes, g√©n√©rez-en de nouveaux depuis votre compte

---
Cofrap Security System
`;

        // Cr√©er et t√©l√©charger le fichier
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `codes_recuperation_2fa_cofrap_${new Date().toISOString().split('T')[0]}.txt`;
        
        // Ajouter temporairement le lien au DOM et cliquer dessus
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Nettoyer l'URL cr√©√©e
        URL.revokeObjectURL(url);
        
        showNotification('Codes de r√©cup√©ration t√©l√©charg√©s avec succ√®s !', 'success');
    }

    // Variable globale pour stocker les codes de r√©cup√©ration
    let currentRecoveryCodes = [];

    // Fonction pour g√©n√©rer et afficher les codes de r√©cup√©ration apr√®s activation 2FA
    function generateAndShowRecoveryCodes() {
        // G√©n√©rer 10 codes de r√©cup√©ration al√©atoirement
        currentRecoveryCodes = [];
        for (let i = 0; i < 10; i++) {
            const code = Math.random().toString(36).substring(2, 10).toUpperCase();
            currentRecoveryCodes.push(code);
        }

        // Afficher les codes dans la section d√©di√©e
        const displayContainer = document.getElementById('recovery-codes-display');
        if (displayContainer) {
            displayContainer.innerHTML = '';
            currentRecoveryCodes.forEach((code, index) => {
                const codeElement = document.createElement('div');
                codeElement.className = 'recovery-code-simple';
                codeElement.textContent = `${(index + 1).toString().padStart(2, '0')}. ${code}`;
                displayContainer.appendChild(codeElement);
            });
        }

        // Afficher la section de r√©cup√©ration
        const recoverySection = document.getElementById('recovery-section');
        if (recoverySection) {
            recoverySection.style.display = 'block';
        }
    }

    // Fonction pour imprimer les codes depuis l'affichage direct
    function printRecoveryCodesFromDirect() {
        if (currentRecoveryCodes.length === 0) {
            showNotification('Aucun code de r√©cup√©ration disponible', 'warning');
            return;
        }

        // Utiliser la m√™me logique que printRecoveryCodes mais avec currentRecoveryCodes
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleDateString('fr-FR');
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Codes de R√©cup√©ration 2FA - Cofrap</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        padding: 20px; 
                        line-height: 1.6;
                    }
                    .header { 
                        text-align: center; 
                        margin-bottom: 30px; 
                        border-bottom: 2px solid #333; 
                        padding-bottom: 20px;
                    }
                    .codes-grid { 
                        display: grid; 
                        grid-template-columns: repeat(2, 1fr); 
                        gap: 15px; 
                        margin: 20px 0;
                    }
                    .code-item { 
                        border: 1px solid #ddd; 
                        padding: 15px; 
                        border-radius: 5px; 
                        font-family: 'Courier New', monospace; 
                        font-weight: bold;
                        font-size: 14px;
                    }
                    .warning { 
                        background-color: #fff3cd; 
                        border: 1px solid #ffeaa7; 
                        color: #856404; 
                        padding: 15px; 
                        border-radius: 5px; 
                        margin: 20px 0;
                    }
                    .instructions {
                        margin-top: 30px;
                        font-size: 12px;
                        color: #666;
                    }
                    @media print {
                        body { font-size: 12px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Codes de R√©cup√©ration 2FA</h1>
                    <h2>Cofrap Security</h2>
                    <p>G√©n√©r√©s le : ${currentDate}</p>
                </div>
                
                <div class="warning">
                    <strong>‚ö†Ô∏è IMPORTANT :</strong> Conservez ces codes dans un endroit s√ªr et s√©curis√©. 
                    Ils vous permettront de r√©cup√©rer l'acc√®s √† votre compte si vous perdez votre appareil d'authentification.
                </div>
                
                <div class="codes-grid">
                    ${currentRecoveryCodes.map((code, index) => `
                        <div class="code-item">
                            ${index + 1}. ${code}
                        </div>
                    `).join('')}
                </div>
                
                <div class="instructions">
                    <h3>Instructions d'utilisation :</h3>
                    <ul>
                        <li>Chaque code ne peut √™tre utilis√© qu'une seule fois</li>
                        <li>Utilisez ces codes uniquement si vous perdez l'acc√®s √† votre appareil 2FA</li>
                        <li>Conservez ce document dans un coffre-fort ou un endroit s√©curis√©</li>
                        <li>Si vous utilisez tous vos codes, g√©n√©rez-en de nouveaux depuis votre compte</li>
                    </ul>
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.focus();
        
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
        
        showNotification('Impression des codes de r√©cup√©ration...', 'info');
    }

    // Fonction pour t√©l√©charger les codes depuis l'affichage direct
    function downloadRecoveryCodesFromDirect() {
        if (currentRecoveryCodes.length === 0) {
            showNotification('Aucun code de r√©cup√©ration disponible', 'warning');
            return;
        }

        const currentDate = new Date().toLocaleDateString('fr-FR');
        const currentTime = new Date().toLocaleTimeString('fr-FR');
        
        const content = `CODES DE R√âCUP√âRATION 2FA - COFRAP
G√©n√©r√©s le : ${currentDate} √† ${currentTime}

‚ö†Ô∏è IMPORTANT : Conservez ces codes dans un endroit s√ªr et s√©curis√©.
Ils vous permettront de r√©cup√©rer l'acc√®s √† votre compte si vous perdez votre appareil d'authentification.

CODES DE R√âCUP√âRATION :
${currentRecoveryCodes.map((code, index) => `${(index + 1).toString().padStart(2, '0')}. ${code}`).join('\n')}

INSTRUCTIONS D'UTILISATION :
- Chaque code ne peut √™tre utilis√© qu'une seule fois
- Utilisez ces codes uniquement si vous perdez l'acc√®s √† votre appareil 2FA
- Conservez ce fichier dans un endroit s√©curis√©
- Si vous utilisez tous vos codes, g√©n√©rez-en de nouveaux depuis votre compte

---
Cofrap Security System
`;

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `codes_recuperation_2fa_cofrap_${new Date().toISOString().split('T')[0]}.txt`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
        
        showNotification('Codes de r√©cup√©ration t√©l√©charg√©s avec succ√®s !', 'success');
    }

    // Fonction de notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} notification`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="close" onclick="this.parentElement.remove()">&times;</button>
        `;

        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.workflow-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    position: relative;
}

.workflow-steps::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gray-300);
    z-index: 1;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    padding: 0.5rem;
    z-index: 2;
    position: relative;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--gray-300);
    color: var(--gray-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background: var(--primary-color);
    color: white;
}

.step.completed .step-number {
    background: var(--success-color, #28a745);
    color: white;
}

.step-label {
    font-size: 0.875rem;
    text-align: center;
    color: var(--gray-600);
    max-width: 80px;
}

.step.active .step-label {
    color: var(--primary-color);
    font-weight: 600;
}

.step.completed .step-label {
    color: var(--success-color, #28a745);
    font-weight: 600;
}

.setup-steps {
    max-width: 600px;
    margin: 0 auto;
}

.step {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius-lg);
    background: white;
}

.step-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    margin-right: 1rem;
}

.qr-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
}

.qr-container {
    text-align: center;
}

.qr-placeholder {
    padding: 2rem;
    border: 2px dashed var(--gray-300);
    border-radius: var(--border-radius);
    color: var(--gray-600);
}

.qr-image {
    max-width: 200px;
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius);
}

.qr-info {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--border-radius);
}

.qr-instructions {
    font-size: 0.9rem;
}

.qr-instructions ol {
    padding-left: 1.2rem;
}

.qr-instructions ul {
    padding-left: 1.5rem;
    margin-top: 0.5rem;
}

.recovery-codes-container {
    background: var(--gray-50);
    padding: 1.5rem;
    border-radius: var(--border-radius);
}

.recovery-code-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius);
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

.code-number {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius-sm);
    margin-right: 0.75rem;
    font-size: 0.8rem;
    min-width: 30px;
    text-align: center;
}

.code-value {
    color: var(--primary-color);
    letter-spacing: 1px;
}

.recovery-codes-display {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin: 15px 0;
    padding: 15px;
    background: white;
    border-radius: var(--border-radius);
    border: 1px solid var(--gray-200);
}

.recovery-code-simple {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    padding: 8px 12px;
    background: var(--gray-50);
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius-sm);
    text-align: center;
    color: var(--primary-color);
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .workflow-steps .step-label {
        font-size: 0.75rem;
        max-width: 60px;
    }
    
    .workflow-steps .step-number {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
    }
    
    .qr-section {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .recovery-code-item {
        flex-direction: column;
        text-align: center;
    }
    
    .code-number {
        margin-right: 0;
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %} 